<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¸Šå‚³ç…§ç‰‡èˆ‡æè¿°</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- EXIF.js for GPS data reading -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body class="bg-light">

    <div class="container py-5">
        <div class="card shadow-lg mx-auto" style="max-width: 600px;">
            <div class="card-body">
                <h2 class="text-center mb-4">ğŸ“¸ ä¸Šå‚³ä½ çš„ç…§ç‰‡</h2>

                <!-- ç‹€æ…‹é¡¯ç¤ºå€åŸŸ -->
                <div id="status" class="alert alert-info text-center mb-3" role="alert">
                    è«‹é¸æ“‡ä¸€å¼µç…§ç‰‡
                </div>

                <!-- ç…§ç‰‡é è¦½å€åŸŸ -->
                <div id="imagePreview" class="text-center mb-3" style="display: none;">
                    <img id="previewImage" class="img-fluid rounded shadow" style="max-height: 300px;">
                </div>

                <!-- GPS è³‡è¨Šé¡¯ç¤ºå€åŸŸ -->
                <div id="gpsInfo" class="alert alert-success mb-3" style="display: none;">
                    <h6 class="alert-heading">ğŸ“ GPS è³‡è¨Š</h6>
                    <div id="gpsDetails"></div>
                </div>

                <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm">
                    <div class="mb-3">
                        <label for="photo" class="form-label fw-bold">é¸æ“‡ç…§ç‰‡ï¼š</label>
                        <input type="file" class="form-control" name="photo" id="photo" accept="image/*" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label fw-bold">ç…§ç‰‡æè¿°ï¼š</label>
                        <textarea class="form-control" name="description" id="description" rows="4" placeholder="è«‹å…ˆé¸æ“‡åŒ…å« GPS è³‡è¨Šçš„ç…§ç‰‡..." disabled></textarea>
                        <div class="form-text">è«‹å…ˆé¸æ“‡åŒ…å« GPS è³‡è¨Šçš„ç…§ç‰‡æ‰èƒ½å¡«å¯«æè¿°</div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>ä¸Šå‚³ ğŸš€</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ç²å– DOM å…ƒç´ 
        const statusDiv = document.getElementById('status');
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');
        const gpsInfo = document.getElementById('gpsInfo');
        const gpsDetails = document.getElementById('gpsDetails');
        const photoInput = document.getElementById('photo');
        const descriptionTextarea = document.getElementById('description');
        const submitBtn = document.getElementById('submitBtn');
        const uploadForm = document.getElementById('uploadForm');

        // å„²å­˜ GPS åº§æ¨™
        let hasGPS = false;
        let gpsCoordinates = null;

        // ç›£è½ç…§ç‰‡é¸æ“‡
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                resetForm();
                return;
            }

            // é¡¯ç¤ºç…§ç‰‡é è¦½
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                imagePreview.style.display = 'block';
            }
            reader.readAsDataURL(file);

            // è®€å– EXIF æ•¸æ“š
            statusDiv.innerHTML = "æ­£åœ¨è®€å–ç…§ç‰‡è³‡è¨Š...";
            statusDiv.className = "alert alert-warning text-center mb-3";
            
            EXIF.getData(file, function() {
                const exifData = EXIF.getAllTags(this);
                console.log('EXIF data:', exifData);
                console.log('GPS Latitude:', exifData.GPSLatitude);
                console.log('GPS Longitude:', exifData.GPSLongitude);
                console.log('GPS LatitudeRef:', exifData.GPSLatitudeRef);
                console.log('GPS LongitudeRef:', exifData.GPSLongitudeRef);
                
                // å˜—è©¦ä½¿ç”¨ EXIF.js çš„å…¶ä»–æ–¹æ³•
                console.log('EXIF.getTag(this, "GPSLatitude"):', EXIF.getTag(this, "GPSLatitude"));
                console.log('EXIF.getTag(this, "GPSLongitude"):', EXIF.getTag(this, "GPSLongitude"));
                console.log('EXIF.getTag(this, "GPSLatitudeRef"):', EXIF.getTag(this, "GPSLatitudeRef"));
                console.log('EXIF.getTag(this, "GPSLongitudeRef"):', EXIF.getTag(this, "GPSLongitudeRef"));

                if (exifData.GPSLatitude && exifData.GPSLongitude) {
                    console.log('GPS Latitude array:', exifData.GPSLatitude);
                    console.log('GPS Longitude array:', exifData.GPSLongitude);
                    
                    // ç›´æ¥ä½¿ç”¨åŸå§‹æ•¸æ“š
                    const latitude = convertDMSToDD(
                        exifData.GPSLatitude[0],
                        exifData.GPSLatitude[1],
                        exifData.GPSLatitude[2],
                        exifData.GPSLatitudeRef
                    );

                    const longitude = convertDMSToDD(
                        exifData.GPSLongitude[0],
                        exifData.GPSLongitude[1],
                        exifData.GPSLongitude[2],
                        exifData.GPSLongitudeRef
                    );

                    console.log('Converted latitude:', latitude);
                    console.log('Converted longitude:', longitude);

                    // æª¢æŸ¥è½‰æ›çµæœæ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—
                    if (!isNaN(latitude) && !isNaN(longitude) && isFinite(latitude) && isFinite(longitude)) {
                        // å„²å­˜ GPS åº§æ¨™
                        gpsCoordinates = { latitude, longitude };
                        hasGPS = true;

                        // é¡¯ç¤º GPS è³‡è¨Š
                        const dateTime = exifData.DateTimeOriginal || exifData.DateTime || 'æœªçŸ¥';
                        gpsDetails.innerHTML = `
                            <p class="mb-1"><strong>ç·¯åº¦:</strong> ${latitude.toFixed(6)}Â°</p>
                            <p class="mb-1"><strong>ç¶“åº¦:</strong> ${longitude.toFixed(6)}Â°</p>
                            <p class="mb-2"><strong>æ‹æ”æ™‚é–“:</strong> ${dateTime}</p>
                            <a href="https://www.google.com/maps?q=${latitude},${longitude}" 
                               target="_blank" 
                               class="btn btn-sm btn-outline-success">
                                ğŸ“ åœ¨ Google Maps ä¸­æŸ¥çœ‹ä½ç½®
                            </a>
                        `;
                        gpsInfo.style.display = 'block';

                        // å•Ÿç”¨æè¿°è¼¸å…¥å’Œä¸Šå‚³æŒ‰éˆ•
                        descriptionTextarea.disabled = false;
                        descriptionTextarea.placeholder = "è«‹è¼¸å…¥ç…§ç‰‡å…§å®¹...";
                        submitBtn.disabled = false;
                        
                        statusDiv.innerHTML = "âœ… æˆåŠŸè®€å– GPS è³‡è¨Šï¼ç¾åœ¨å¯ä»¥å¡«å¯«æè¿°ä¸¦ä¸Šå‚³";
                        statusDiv.className = "alert alert-success text-center mb-3";
                    } else {
                        // GPS åº§æ¨™è½‰æ›å¤±æ•—
                        hasGPS = false;
                        gpsCoordinates = null;
                        gpsInfo.style.display = 'none';
                        
                        // ç¦ç”¨æè¿°è¼¸å…¥å’Œä¸Šå‚³æŒ‰éˆ•
                        descriptionTextarea.disabled = true;
                        descriptionTextarea.value = '';
                        descriptionTextarea.placeholder = "è«‹å…ˆé¸æ“‡åŒ…å« GPS è³‡è¨Šçš„ç…§ç‰‡...";
                        submitBtn.disabled = true;
                        
                        statusDiv.innerHTML = "âŒ GPS åº§æ¨™æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è®€å–ä½ç½®è³‡è¨Š";
                        statusDiv.className = "alert alert-danger text-center mb-3";
                        console.error('Invalid GPS coordinates:', { latitude, longitude });
                    }
                } else {
                    // å˜—è©¦å‚™ç”¨æ–¹æ³•è®€å– GPS
                    console.log('Trying alternative GPS reading method...');
                    const altLat = EXIF.getTag(this, "GPSLatitude");
                    const altLon = EXIF.getTag(this, "GPSLongitude");
                    const altLatRef = EXIF.getTag(this, "GPSLatitudeRef");
                    const altLonRef = EXIF.getTag(this, "GPSLongitudeRef");
                    
                    console.log('Alternative GPS data:', { altLat, altLon, altLatRef, altLonRef });
                    
                    if (altLat && altLon) {
                        console.log('Using alternative GPS data');
                        const latitude = convertDMSToDD(
                            altLat[0],
                            altLat[1],
                            altLat[2],
                            altLatRef
                        );

                        const longitude = convertDMSToDD(
                            altLon[0],
                            altLon[1],
                            altLon[2],
                            altLonRef
                        );

                        console.log('Alternative converted latitude:', latitude);
                        console.log('Alternative converted longitude:', longitude);

                        // æª¢æŸ¥è½‰æ›çµæœæ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—
                        if (!isNaN(latitude) && !isNaN(longitude) && isFinite(latitude) && isFinite(longitude)) {
                            // å„²å­˜ GPS åº§æ¨™
                            gpsCoordinates = { latitude, longitude };
                            hasGPS = true;

                            // é¡¯ç¤º GPS è³‡è¨Š
                            const dateTime = exifData.DateTimeOriginal || exifData.DateTime || 'æœªçŸ¥';
                            gpsDetails.innerHTML = `
                                <p class="mb-1"><strong>ç·¯åº¦:</strong> ${latitude.toFixed(6)}Â°</p>
                                <p class="mb-1"><strong>ç¶“åº¦:</strong> ${longitude.toFixed(6)}Â°</p>
                                <p class="mb-2"><strong>æ‹æ”æ™‚é–“:</strong> ${dateTime}</p>
                                <a href="https://www.google.com/maps?q=${latitude},${longitude}" 
                                   target="_blank" 
                                   class="btn btn-sm btn-outline-success">
                                    ğŸ“ åœ¨ Google Maps ä¸­æŸ¥çœ‹ä½ç½®
                                </a>
                            `;
                            gpsInfo.style.display = 'block';

                            // å•Ÿç”¨æè¿°è¼¸å…¥å’Œä¸Šå‚³æŒ‰éˆ•
                            descriptionTextarea.disabled = false;
                            descriptionTextarea.placeholder = "è«‹è¼¸å…¥ç…§ç‰‡å…§å®¹...";
                            submitBtn.disabled = false;
                            
                            statusDiv.innerHTML = "âœ… æˆåŠŸè®€å– GPS è³‡è¨Šï¼ç¾åœ¨å¯ä»¥å¡«å¯«æè¿°ä¸¦ä¸Šå‚³";
                            statusDiv.className = "alert alert-success text-center mb-3";
                        } else {
                            // å‚™ç”¨æ–¹æ³•ä¹Ÿå¤±æ•—
                            hasGPS = false;
                            gpsCoordinates = null;
                            gpsInfo.style.display = 'none';
                            
                            // ç¦ç”¨æè¿°è¼¸å…¥å’Œä¸Šå‚³æŒ‰éˆ•
                            descriptionTextarea.disabled = true;
                            descriptionTextarea.value = '';
                            descriptionTextarea.placeholder = "è«‹å…ˆé¸æ“‡åŒ…å« GPS è³‡è¨Šçš„ç…§ç‰‡...";
                            submitBtn.disabled = true;
                            
                            statusDiv.innerHTML = "âŒ æ­¤ç…§ç‰‡ä¸åŒ…å« GPS è³‡è¨Šï¼Œè«‹é¸æ“‡å…¶ä»–ç…§ç‰‡";
                            statusDiv.className = "alert alert-danger text-center mb-3";
                        }
                    } else {
                        // æ²’æœ‰ GPS è³‡è¨Š
                        hasGPS = false;
                        gpsCoordinates = null;
                        gpsInfo.style.display = 'none';
                        
                        // ç¦ç”¨æè¿°è¼¸å…¥å’Œä¸Šå‚³æŒ‰éˆ•
                        descriptionTextarea.disabled = true;
                        descriptionTextarea.value = '';
                        descriptionTextarea.placeholder = "è«‹å…ˆé¸æ“‡åŒ…å« GPS è³‡è¨Šçš„ç…§ç‰‡...";
                        submitBtn.disabled = true;
                        
                        statusDiv.innerHTML = "âŒ æ­¤ç…§ç‰‡ä¸åŒ…å« GPS è³‡è¨Šï¼Œè«‹é¸æ“‡å…¶ä»–ç…§ç‰‡";
                        statusDiv.className = "alert alert-danger text-center mb-3";
                    }
                }
            });
        });

        // å°‡åº¦åˆ†ç§’æ ¼å¼è½‰æ›ç‚ºåé€²ä½åº¦æ•¸
        function convertDMSToDD(degrees, minutes, seconds, direction) {
            console.log('Converting GPS:', { degrees, minutes, seconds, direction });
            
            // ç›´æ¥ä½¿ç”¨åŸå§‹å€¼ï¼Œä¸åšé¡å¤–è™•ç†
            let dd = degrees + (minutes / 60) + (seconds / 3600);
            console.log('Calculated DD:', dd);
            
            if (direction === 'S' || direction === 'W') {
                dd = dd * -1;
            }
            console.log('Final coordinate:', dd);
            return dd;
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            imagePreview.style.display = 'none';
            gpsInfo.style.display = 'none';
            descriptionTextarea.disabled = true;
            descriptionTextarea.value = '';
            descriptionTextarea.placeholder = "è«‹å…ˆé¸æ“‡åŒ…å« GPS è³‡è¨Šçš„ç…§ç‰‡...";
            submitBtn.disabled = true;
            hasGPS = false;
            gpsCoordinates = null;
            statusDiv.innerHTML = "è«‹é¸æ“‡ä¸€å¼µç…§ç‰‡";
            statusDiv.className = "alert alert-info text-center mb-3";
        }

        // è¡¨å–®æäº¤é©—è­‰
        uploadForm.addEventListener('submit', function(e) {
            if (!hasGPS) {
                e.preventDefault();
                alert('è«‹é¸æ“‡åŒ…å« GPS è³‡è¨Šçš„ç…§ç‰‡ï¼');
                return false;
            }
            
            if (!descriptionTextarea.value.trim()) {
                e.preventDefault();
                alert('è«‹å¡«å¯«ç…§ç‰‡æè¿°ï¼');
                descriptionTextarea.focus();
                return false;
            }
        });
    </script>
</body>
</html>
